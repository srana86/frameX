// Prisma Schema for FrameX Multi-Tenant System
// All tenant-specific data includes tenantId for isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// MULTI-TENANT CORE
// ============================================================

model Tenant {
  id        String       @id @default(uuid())
  name      String
  email     String       @unique
  phone     String?
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  domains               TenantDomain[]
  settings              TenantSettings?
  users                 User[]
  products              Product[]
  categories            Category[]
  orders                Order[]
  customers             Customer[]
  inventory             Inventory[]
  coupons               Coupon[]
  payments              Payment[]
  pages                 Page[]
  heroSlides            HeroSlide[]
  reviews               Review[]
  pageCategories        PageCategory[]
  promotionalBanners    PromotionalBanner[]
  inventoryTransactions InventoryTransaction[]

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model TenantDomain {
  id            String    @id @default(uuid())
  tenantId      String
  subdomain     String?   @unique // "acme" → acme.framextech.com
  customDomain  String?   @unique // shop.example.com
  primaryDomain String // The active domain
  verified      Boolean   @default(false)
  sslStatus     SSLStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([primaryDomain])
}

model TenantSettings {
  id             String  @id @default(uuid())
  tenantId       String  @unique
  brandName      String
  logo           String?
  favicon        String?
  currency       String  @default("USD")
  currencySymbol String  @default("$")
  timezone       String  @default("UTC")
  language       String  @default("en")
  theme          Json? // {primaryColor, secondaryColor, etc}
  socialLinks    Json? // {facebook, instagram, twitter}
  contactInfo    Json? // {email, phone, address}
  orderEnabled   Boolean @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

// ============================================================
// USERS & AUTH
// ============================================================

model User {
  id            String     @id @default(uuid())
  tenantId      String? // NULL for super admin
  email         String     @unique
  password      String
  name          String?
  phone         String?
  role          UserRole   @default(STAFF)
  status        UserStatus @default(ACTIVE)
  emailVerified Boolean    @default(false)
  isDeleted     Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([role])
}

// ============================================================
// PRODUCTS & CATEGORIES
// ============================================================

model Category {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  slug        String
  description String?
  image       String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
}

model Product {
  id           String        @id @default(uuid())
  tenantId     String
  categoryId   String?
  name         String
  slug         String
  description  String?
  price        Decimal       @db.Decimal(10, 2)
  comparePrice Decimal?      @db.Decimal(10, 2)
  images       String[]
  status       ProductStatus @default(ACTIVE)
  featured     Boolean       @default(false)
  sortOrder    Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category              Category?              @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  inventory             Inventory?
  orderItems            OrderItem[]
  reviews               Review[]
  inventoryTransactions InventoryTransaction[]

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@index([tenantId, categoryId])
  @@index([tenantId, featured])
}

model Inventory {
  id        String   @id @default(uuid())
  tenantId  String
  productId String   @unique
  quantity  Int      @default(0)
  lowStock  Int      @default(5)
  updatedAt DateTime @updatedAt

  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product               Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryTransactions InventoryTransaction[]

  @@index([tenantId])
}

model InventoryTransaction {
  id            String                   @id @default(uuid())
  tenantId      String
  inventoryId   String
  productId     String
  type          InventoryTransactionType
  quantity      Int // Amount changed (+/-)
  previousStock Int
  newStock      Int
  orderId       String?
  notes         String?
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

enum InventoryTransactionType {
  ORDER
  RESTOCK
  ADJUSTMENT
  RETURN
}

// ============================================================
// CUSTOMERS & ORDERS
// ============================================================

model Customer {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  phone     String
  email     String?
  address   String?
  city      String?
  notes     String?
  blocked   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([tenantId, phone])
  @@index([tenantId])
}

model Order {
  id              String      @id @default(uuid())
  tenantId        String
  customerId      String?
  orderNumber     String
  status          OrderStatus @default(PENDING)
  subtotal        Decimal     @db.Decimal(10, 2)
  discount        Decimal     @default(0) @db.Decimal(10, 2)
  deliveryFee     Decimal     @default(0) @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  notes           String?
  deliveryAddress String?
  couponCode      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  isDeleted       Boolean     @default(false)

  // Courier Info
  courierServiceId String?
  consignmentId    String?
  trackingNumber   String?
  courierStatus    String?
  courierMetadata  Json?

  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items    OrderItem[]
  payment  Payment?

  @@unique([tenantId, orderNumber])
  @@index([tenantId, status])
  @@index([tenantId, createdAt(sort: Desc)])
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  name      String // Snapshot of product name
  price     Decimal @db.Decimal(10, 2)
  quantity  Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)
}

// ============================================================
// PAYMENTS & COUPONS
// ============================================================

model Payment {
  id            String        @id @default(uuid())
  tenantId      String
  orderId       String        @unique
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  method        String?
  transactionId String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
}

model Coupon {
  id            String       @id @default(uuid())
  tenantId      String
  code          String
  discountType  DiscountType @default(PERCENTAGE)
  discountValue Decimal      @db.Decimal(10, 2)
  minOrderValue Decimal?     @db.Decimal(10, 2)
  maxUses       Int?
  usedCount     Int          @default(0)
  expiresAt     DateTime?
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  couponUsages CouponUsage[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
}

// ============================================================
// CONTENT (Pages, Hero Slides, Reviews)
// ============================================================

model Page {
  id             String   @id @default(uuid())
  tenantId       String
  slug           String
  title          String
  content        String?  @db.Text
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  pageCategoryId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pageCategory PageCategory? @relation(fields: [pageCategoryId], references: [id], onDelete: SetNull)

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
}

model PageCategory {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  slug      String
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pages  Page[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
}

model HeroSlide {
  id          String   @id @default(uuid())
  tenantId    String
  title       String?
  subtitle    String?
  image       String
  mobileImage String?
  link        String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
}

model PromotionalBanner {
  id        String   @id @default(uuid())
  tenantId  String
  title     String?
  image     String?
  link      String?
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Review {
  id          String   @id @default(uuid())
  tenantId    String
  productId   String
  name        String
  rating      Int
  comment     String?
  approved    Boolean  @default(false)
  verified    Boolean  @default(false)
  images      String[]
  avatarColor String?
  initials    String?
  date        String?
  createdAt   DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId, approved])
  @@index([productId])
}

// ============================================================
// ENUMS
// ============================================================

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  INACTIVE
}

enum SSLStatus {
  PENDING
  ACTIVE
  FAILED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  STAFF
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// ============================================================
// STORE USER (Extended for store-api)
// ============================================================

model StoreUser {
  id                  String          @id @default(uuid())
  tenantId            String
  fullName            String
  email               String?
  phone               String?
  emailVerified       Boolean         @default(false)
  password            String?
  googleId            String?
  role                StoreUserRole   @default(CUSTOMER)
  status              StoreUserStatus @default(IN_PROGRESS)
  needsPasswordChange Boolean         @default(false)
  passwordChangedAt   DateTime?
  resetToken          String?
  resetTokenExpiry    DateTime?
  isDeleted           Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@unique([tenantId, email])
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([role])
}

enum StoreUserRole {
  CUSTOMER
  MERCHANT
  ADMIN
}

enum StoreUserStatus {
  IN_PROGRESS
  BLOCKED
}

// ============================================================
// AFFILIATE SYSTEM
// ============================================================

model Affiliate {
  id               String          @id @default(uuid())
  tenantId         String
  userId           String
  promoCode        String
  status           AffiliateStatus @default(ACTIVE)
  totalEarnings    Decimal         @default(0) @db.Decimal(10, 2)
  totalWithdrawn   Decimal         @default(0) @db.Decimal(10, 2)
  availableBalance Decimal         @default(0) @db.Decimal(10, 2)
  totalOrders      Int             @default(0)
  deliveredOrders  Int             @default(0)
  currentLevel     Int             @default(1)
  assignedCouponId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  commissions AffiliateCommission[]
  withdrawals AffiliateWithdrawal[]

  @@unique([tenantId, promoCode])
  @@index([tenantId, userId])
}

model AffiliateSettings {
  id                  String   @id @default(uuid())
  tenantId            String   @unique
  enabled             Boolean  @default(false)
  minWithdrawalAmount Decimal  @default(500) @db.Decimal(10, 2)
  commissionLevels    Json?
  salesThresholds     Json?
  cookieExpiryDays    Int      @default(30)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model AffiliateCommission {
  id                   String                    @id @default(uuid())
  tenantId             String
  affiliateId          String
  orderId              String
  level                Int
  orderTotal           Decimal                   @db.Decimal(10, 2)
  commissionPercentage Decimal                   @db.Decimal(5, 2)
  commissionAmount     Decimal                   @db.Decimal(10, 2)
  status               AffiliateCommissionStatus @default(PENDING)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([affiliateId])
  @@index([orderId])
}

model AffiliateWithdrawal {
  id             String                    @id @default(uuid())
  tenantId       String
  affiliateId    String
  amount         Decimal                   @db.Decimal(10, 2)
  status         AffiliateWithdrawalStatus @default(PENDING)
  paymentMethod  String?
  paymentDetails Json?
  requestedAt    DateTime                  @default(now())
  processedAt    DateTime?
  processedBy    String?
  notes          String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([affiliateId])
}

enum AffiliateStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AffiliateCommissionStatus {
  PENDING
  APPROVED
  CANCELLED
}

enum AffiliateWithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        String           @id @default(uuid())
  tenantId  String
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  read      Boolean          @default(false)
  link      String?
  data      Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([tenantId, userId])
  @@index([read])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  ORDER
}

// ============================================================
// VISITS & TRACKING
// ============================================================

model Visit {
  id            String   @id @default(uuid())
  tenantId      String
  ipAddress     String
  path          String   @default("/")
  referrer      String?
  userAgent     String?
  visitCount    Int      @default(1)
  ipGeolocation Json?
  lastVisitedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId])
  @@index([ipAddress])
  @@index([path])
}

model FBEvent {
  id        String   @id @default(uuid())
  tenantId  String
  eventName String
  eventId   String?  @unique
  eventData Json?
  userData  Json?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([eventName])
  @@index([timestamp])
}

// ============================================================
// BUDGET & INVESTMENT
// ============================================================

model Budget {
  id        String    @id @default(uuid())
  tenantId  String
  name      String
  category  String?
  amount    Decimal   @db.Decimal(10, 2)
  spent     Decimal   @default(0) @db.Decimal(10, 2)
  period    String
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean   @default(true)
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId])
}

model Investment {
  id        String   @id @default(uuid())
  tenantId  String
  key       String
  value     Decimal  @db.Decimal(10, 2)
  category  String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

// ============================================================
// EMAIL SYSTEM
// ============================================================

model EmailTemplate {
  id              String     @id @default(uuid())
  tenantId        String
  event           EmailEvent
  name            String
  description     String?
  subject         String
  fromName        String?
  fromEmail       String?
  replyTo         String?
  previewText     String?
  design          Json?
  html            String?    @db.Text
  variables       String[]
  enabled         Boolean    @default(true)
  testRecipient   String?
  lastPublishedAt DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([tenantId, event])
  @@index([tenantId])
}

model EmailProviderSettings {
  id                 String   @id @default(uuid())
  tenantId           String   @unique
  defaultProviderId  String?
  fallbackProviderId String?
  providers          Json? // Array of provider configs
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

enum EmailEvent {
  ORDER_CONFIRMATION
  PAYMENT_CONFIRMATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
  ABANDONED_CART
  PASSWORD_RESET
  ACCOUNT_WELCOME
  ACCOUNT_VERIFICATION
  REVIEW_REQUEST
  LOW_STOCK_ALERT
  ADMIN_NEW_ORDER_ALERT
}

// ============================================================
// SUBSCRIPTION & PLANS (Server App)
// ============================================================

model SubscriptionPlan {
  id                 String       @id @default(uuid())
  tenantId           String? // Null for platform-level plans
  name               String
  description        String?
  basePrice          Decimal      @db.Decimal(10, 2)
  price              Decimal      @db.Decimal(10, 2)
  billingCycle       BillingCycle
  billingCycleMonths Int
  features           Json?
  featuresList       String[]
  isActive           Boolean      @default(true)
  isPopular          Boolean      @default(false)
  sortOrder          Int          @default(0)
  buttonText         String       @default("Get Started")
  buttonVariant      String       @default("outline")
  iconType           String       @default("star")
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  subscriptions MerchantSubscription[]

  @@index([isActive])
  @@index([billingCycleMonths])
}

model MerchantSubscription {
  id                 String             @id @default(uuid())
  tenantId           String?
  merchantId         String
  planId             String
  planName           String?
  status             SubscriptionStatus
  billingCycle       BillingCycle
  billingCycleMonths Int
  amount             Decimal            @db.Decimal(10, 2)
  currency           String             @default("BDT")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  nextBillingDate    DateTime?
  trialEndsAt        DateTime?
  gracePeriodEndsAt  DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  cancelledAt        DateTime?
  autoRenew          Boolean            @default(true)
  totalPaid          Decimal            @default(0) @db.Decimal(10, 2)
  renewalCount       Int                @default(0)
  paymentMethodId    String?
  lastPaymentDate    DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([merchantId])
  @@index([planId])
  @@index([status])
}

enum BillingCycle {
  MONTHLY
  SEMI_ANNUAL
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  PAST_DUE
  CANCELLED
  EXPIRED
  GRACE_PERIOD
}

// ============================================================
// MERCHANT (Server App)
// ============================================================

model Merchant {
  id             String       @id @default(uuid())
  name           String
  email          String       @unique
  phone          String?
  status         TenantStatus @default(ACTIVE)
  customDomain   String?
  deploymentUrl  String?
  subscriptionId String?
  settings       Json? // {brandName, logo, theme, currency, timezone}
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([status])
}

// ============================================================
// CONFIG MODELS
// ============================================================

model BrandConfig {
  id             String   @id @default(uuid())
  tenantId       String   @unique
  name           String
  logo           String?
  favicon        String?
  primaryColor   String?
  secondaryColor String?
  currencyIso    String   @default("BDT")
  currencySymbol String   @default("৳")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model DeliveryServiceConfig {
  id                          String   @id @default(uuid())
  tenantId                    String   @unique
  defaultDeliveryCharge       Decimal  @db.Decimal(10, 2)
  enableCODForDefault         Boolean  @default(true)
  deliveryChargeNotRefundable Boolean  @default(false)
  weightBasedCharges          Json? // [{weight, extraCharge}]
  deliveryOption              String   @default("districts")
  specificDeliveryCharges     Json? // [{location, charge}]
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

model CourierServicesConfig {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  services  Json? // [{id, name, enabled, logo, credentials}]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SSLCommerzConfig {
  id            String   @id @default(uuid())
  tenantId      String   @unique
  enabled       Boolean  @default(false)
  storeId       String?
  storePassword String?
  isLive        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model OAuthConfig {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  google    Json? // {enabled, clientId, clientSecret}
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdsConfig {
  id               String   @id @default(uuid())
  tenantId         String   @unique
  metaPixel        Json? // {enabled, pixelId, serverSideTracking}
  googleTagManager Json? // {enabled, containerId}
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ============================================================
// BLOCKED CUSTOMERS
// ============================================================

model BlockedCustomer {
  id        String   @id @default(uuid())
  tenantId  String
  phone     String?
  email     String?
  reason    String?
  blockedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([phone])
  @@index([email])
}

// ============================================================
// COUPON USAGE (Extended)
// ============================================================

model CouponUsage {
  id              String   @id @default(uuid())
  tenantId        String
  couponId        String
  couponCode      String
  orderId         String
  customerId      String?
  customerEmail   String?
  customerPhone   String?
  discountApplied Decimal  @db.Decimal(10, 2)
  orderTotal      Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([couponId])
  @@index([orderId])
}

// ============================================================
// PRODUCT VIEWERS
// ============================================================

model ProductViewer {
  id           String   @id @default(uuid())
  tenantId     String
  productId    String
  sessionId    String
  ipAddress    String?
  userAgent    String?
  viewDuration Int? // seconds
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([productId])
  @@index([sessionId])
}

// ============================================================
// SERVER APP SPECIFIC
// ============================================================

model ActivityLog {
  id         String   @id @default(uuid())
  tenantId   String?
  userId     String?
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
}

model Invoice {
  id              String        @id @default(uuid())
  tenantId        String?
  merchantId      String
  subscriptionId  String?
  invoiceNumber   String        @unique
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("BDT")
  status          InvoiceStatus @default(PENDING)
  dueDate         DateTime?
  paidAt          DateTime?
  paymentMethodId String?
  items           Json? // [{description, amount}]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([merchantId])
  @@index([status])
}

model Sales {
  id          String   @id @default(uuid())
  tenantId    String?
  merchantId  String
  orderId     String?
  amount      Decimal  @db.Decimal(10, 2)
  productName String?
  productId   String?
  quantity    Int      @default(1)
  saleDate    DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([merchantId])
  @@index([saleDate])
}

model Deployment {
  id            String           @id @default(uuid())
  merchantId    String
  templateId    String?
  status        DeploymentStatus @default(PENDING)
  domain        String?
  deploymentUrl String?
  logs          Json?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([merchantId])
  @@index([status])
}

model FeatureRequest {
  id          String               @id @default(uuid())
  tenantId    String?
  userId      String?
  title       String
  description String?              @db.Text
  status      FeatureRequestStatus @default(PENDING)
  votes       Int                  @default(0)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([status])
}

model DatabaseInfo {
  id           String   @id @default(uuid())
  merchantId   String   @unique
  databaseName String
  databaseUrl  String?
  status       String   @default("active")
  size         BigInt?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Checkout {
  id            String         @id @default(uuid())
  merchantId    String
  sessionId     String         @unique
  amount        Decimal        @db.Decimal(10, 2)
  currency      String         @default("BDT")
  status        CheckoutStatus @default(PENDING)
  items         Json?
  customerId    String?
  customerEmail String?
  metadata      Json?
  expiresAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([merchantId])
  @@index([status])
}

model Settings {
  id        String   @id @default(uuid())
  tenantId  String?  @unique
  key       String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, key])
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum DeploymentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum FeatureRequestStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum CheckoutStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELLED
}
