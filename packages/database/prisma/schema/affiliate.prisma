// ============================================================
// AFFILIATE SYSTEM
// ============================================================

model Affiliate {
  id               String          @id @default(uuid())
  tenantId         String
  userId           String          @unique
  promoCode        String
  status           AffiliateStatus @default(ACTIVE)
  totalEarnings    Decimal         @default(0) @db.Decimal(10, 2)
  totalWithdrawn   Decimal         @default(0) @db.Decimal(10, 2)
  availableBalance Decimal         @default(0) @db.Decimal(10, 2)
  totalOrders      Int             @default(0)
  deliveredOrders  Int             @default(0)
  currentLevel     Int             @default(1)
  assignedCouponId String?
  updatedAt        DateTime        @updatedAt

  user        User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions AffiliateCommission[]
  withdrawals AffiliateWithdrawal[]

  @@unique([tenantId, promoCode])
  @@index([tenantId, userId])
}

model AffiliateSettings {
  id                  String   @id @default(uuid())
  tenantId            String   @unique
  enabled             Boolean  @default(false)
  minWithdrawalAmount Decimal  @default(500) @db.Decimal(10, 2)
  commissionLevels    Json?
  salesThresholds     Json?
  cookieExpiryDays    Int      @default(30)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model AffiliateCommission {
  id                   String                    @id @default(uuid())
  tenantId             String
  affiliateId          String
  orderId              String
  level                Int
  orderTotal           Decimal                   @db.Decimal(10, 2)
  commissionPercentage Decimal                   @db.Decimal(5, 2)
  commissionAmount     Decimal                   @db.Decimal(10, 2)
  status               AffiliateCommissionStatus @default(PENDING)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([affiliateId])
  @@index([orderId])
}

model AffiliateWithdrawal {
  id             String                    @id @default(uuid())
  tenantId       String
  affiliateId    String
  amount         Decimal                   @db.Decimal(10, 2)
  status         AffiliateWithdrawalStatus @default(PENDING)
  paymentMethod  String?
  paymentDetails Json?
  requestedAt    DateTime                  @default(now())
  processedAt    DateTime?
  processedBy    String?
  notes          String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([affiliateId])
}
