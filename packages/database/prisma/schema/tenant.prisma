// ============================================================
// MULTI-TENANT CORE (Merged with Merchant)
// ============================================================

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String?      @unique // URL-safe identifier
  email     String       @unique
  phone     String?
  status    TenantStatus @default(ACTIVE)
  isActive  Boolean      @default(true) // Quick active check
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Domain Limits
  maxDomains Int @default(3) // Maximum custom domains allowed

  // Backend Routing (default for all domains)
  backendHost String @default("127.0.0.1") // Backend server host
  backendPort Int    @default(3000) // Backend server port

  // Deployment Info (merged from Merchant)
  customDomain   String? // Custom domain for the store
  deploymentUrl  String? // Deployed URL
  subscriptionId String? // Current subscription reference

  // Store Relations
  domains               TenantDomain[]
  users                 User[]
  products              Product[]
  categories            Category[]
  orders                Order[]
  customers             Customer[]
  inventory             Inventory[]
  coupons               Coupon[]
  payments              Payment[]
  pages                 Page[]
  heroSlides            HeroSlide[]
  reviews               Review[]
  pageCategories        PageCategory[]
  promotionalBanners    PromotionalBanner[]
  inventoryTransactions InventoryTransaction[]
  settingsList          Settings[]

  // Billing Relations (merged from Merchant)
  invoices        Invoice[]
  sales           Sales[]
  deployments     Deployment[]
  databaseInfo    DatabaseInfo?
  checkouts       Checkout[]
  subscriptions   TenantSubscription[]
  featureRequests FeatureRequest[]
  assets          Asset[]

  // Store Owner relation (for multi-store management)
  ownerAssignment StoreOwnerStore?

  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model TenantDomain {
  id            String  @id @default(uuid())
  tenantId      String
  hostname      String  @unique // The full domain (e.g., shop.example.com)
  subdomain     String? @unique // "acme" â†’ acme.framextech.com
  customDomain  String? @unique // shop.example.com (alias for hostname for custom domains)
  primaryDomain String // The active domain

  // Domain Settings
  isPrimary  Boolean @default(false)
  isWildcard Boolean @default(false) // *.tenant.saas.com

  // Backend Routing (can override tenant defaults)
  backendHost String? // Override tenant's backend host
  backendPort Int? // Override tenant's backend port

  // DNS Verification
  verificationToken  String                   @default(uuid())
  verificationMethod DomainVerificationMethod @default(DNS_TXT)
  dnsVerified        Boolean                  @default(false)
  dnsVerifiedAt      DateTime?
  dnsLastCheckedAt   DateTime?
  dnsCheckError      String?

  // SSL Certificate Status
  sslStatus     SSLStatus   @default(PENDING)
  sslProvider   SSLProvider @default(LETS_ENCRYPT)
  certPath      String? // Path to fullchain.pem
  keyPath       String? // Path to privkey.pem
  certIssuedAt  DateTime?
  certExpiresAt DateTime?

  // Renewal Tracking
  lastRenewalAttempt DateTime?
  lastRenewalError   String?
  renewalAttempts    Int       @default(0)

  // Nginx Configuration
  nginxConfigPath String?
  nginxConfigured Boolean   @default(false)
  nginxLastReload DateTime?

  // Status
  status DomainStatus @default(PENDING_VERIFICATION)

  // Timestamps
  verified  Boolean   @default(false) // Legacy field
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  certificates DomainCertificate[]

  @@index([tenantId])
  @@index([primaryDomain])
  @@index([customDomain])
  @@index([status])
  @@index([sslStatus])
  @@index([certExpiresAt])
  @@index([deletedAt])
}

// ============================================================
// DOMAIN CERTIFICATES (SSL Certificate History)
// ============================================================

model DomainCertificate {
  id       String @id @default(uuid())
  domainId String

  // Certificate identification
  serialNumber String? // X.509 serial number
  fingerprint  String? // SHA-256 fingerprint

  // Issuer details
  issuer     String // "Let's Encrypt", "Cloudflare", etc.
  commonName String // CN from certificate
  altNames   String[] // Subject Alternative Names (SAN)

  // Certificate data (PEM format)
  certPem  String? @db.Text // Full certificate PEM
  chainPem String? @db.Text // CA chain PEM

  // Validity period
  issuedAt  DateTime
  expiresAt DateTime

  // Status
  isActive  Boolean   @default(true) // Currently in use
  revokedAt DateTime? // If revoked

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  domain TenantDomain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId])
  @@index([expiresAt])
  @@index([isActive])
}

// ============================================================
// DOMAIN AUDIT LOG
// ============================================================

model DomainAuditLog {
  id String @id @default(uuid())

  // What happened
  action     DomainAuditAction
  entityType String // "TenantDomain", "DomainCertificate"
  entityId   String // ID of the affected entity

  // Who did it
  actorType String // "system", "api", "worker", "admin"
  actorId   String? // User/service ID if applicable

  // Details
  details   Json? // Additional context as JSON
  ipAddress String? // Request IP if applicable
  userAgent String? // Request user agent

  // Result
  success      Boolean @default(true)
  errorMessage String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}
